---
layout: post
title: How to render something behind everything else
description:
tag: Game Dev ðŸ‘¾
---

I'm working on a skybox in Unity (2022.3.15f1 URP), with a sun that moves to match the scene's main directional light. The style is blocky and inspired by Minecraft, so the sun needs to be square.

## Option 1: Procedural skybox shader

My first approach was to do it the same way as the procedural skybox - in the shader - so I created a new shader graph. I managed to make it work as the shader for the skybox material after tuning some settings - I don't remember what exactly, but something related to depth writing or shadow casting.

The basic idea behind a skybox shader is to use the normalized world position as the view direction, and using that to determine what each pixel in the far away sky should display.

I quickly realized however that even something as simple as drawing a square sun could be quite complex, requiring things like:

1. With the main light's direction as the sun's Z axis, using cross product to determine its X and Y axes (using global Y as the up axis).
1. Projecting view direction onto the sun's plane
1. Displaying a "sun" pixel where projection is smaller than some threshold when decomposed into sun's X and Y axes
1. Avoiding a second sun opposite to the main light by ignoring the case where view direction is looking away from main light

![Blend tree]({% link assets/2023-12-14-z-buffer/skybox-shader-graph.jpeg %})

![Blend tree]({% link assets/2023-12-14-z-buffer/skybox-square-sun.jpeg %})

## Option 2: Camera stacking

Another option is to have a second camera that renders only skybox elements. I did not want to try this route as a second camera seems to make the scene too complex and harder to manipulate and understand.

## Option 3: Skybox objects in main camera

I decided to have skybox elements such as the sun still inside the scene as regular objects and rendered by the main camera.

To make these objects render behind everything else, one could simply physically place them behind everything else.

To do this, one could make them only slightly less distant than the camera's frustum's far plane.

This feels a little fragile however - I wouldn't be totally sure that some edge case would cause elements to momentarily snap behind the camera's far plane, causing hard to detect bugs.

I also don't want to be limited as to how far I can place other objects. If I want to have a world so large or a camera frustum so small that the both meet, the skybox should be unaffected.

### How to make something render behind everything else

I concluded I had to set up a material & shader combination such that an object will render behind everything else except the skybox.
